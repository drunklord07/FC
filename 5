#!/bin/bash

echo -e "\n🔍 IAM Server Certificate Expiration Audit (Global Scope)\n"

# Get current time in ISO 8601 format
now=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# Fetch certificates
certs=$(aws iam list-server-certificates --output json 2>/dev/null)

# Debug: show raw output if needed
echo "🔧 Raw AWS Response:"
echo "$certs"
echo ""

# Check if any certs exist
if [[ "$certs" == *"ServerCertificateMetadataList\": []"* ]] || [[ -z "$certs" ]]; then
  echo "✅ No IAM server certificates found. Environment is compliant."
  exit 0
fi

# Print table header
printf "%-30s %-20s %-15s %-25s %-15s\n" "Certificate Name" "Certificate ID" "Account ID" "Expiration Date" "Status"
echo "---------------------------------------------------------------------------------------------------------------------------"

# Extract individual cert blocks and evaluate them
echo "$certs" | grep -o '{[^}]*}' | while read -r cert; do
  name=$(echo "$cert" | grep -o '"ServerCertificateName":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  id=$(echo "$cert" | grep -o '"ServerCertificateId":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  expiration=$(echo "$cert" | grep -o '"Expiration":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  arn=$(echo "$cert" | grep -o '"Arn":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  uid=$(echo "$arn" | cut -d':' -f5)

  # Determine if expired
  if [[ "$expiration" < "$now" ]]; then
    status="Non-Compliant"
  else
    status="Compliant"
  fi

  # Print table row
  printf "%-30s %-20s %-15s %-25s %-15s\n" "$name" "$id" "$uid" "$expiration" "$status"
done
