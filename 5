#!/bin/bash

echo -e "\n🔍 Starting IAM Server Certificate Expiration Audit...\n"

# Current date in ISO format (UTC)
now=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# Print table header
printf "%-30s %-20s %-15s %-25s %-15s\n" "Certificate Name" "Certificate ID" "Account ID" "Expiration Date" "Status"
echo "---------------------------------------------------------------------------------------------------------------------------"

# Get certificate metadata list
certs=$(aws iam list-server-certificates --query 'ServerCertificateMetadataList' --output json 2>/dev/null)

# Check if any certificates are present
if [[ "$certs" == *"[]"* || -z "$certs" ]]; then
  echo -e "\n✅ No IAM server certificates found. Environment is compliant."
  exit 0
fi

# Process each certificate
echo "$certs" | grep -o '{[^}]*}' | while read -r cert; do
  name=$(echo "$cert" | grep -o '"ServerCertificateName":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  id=$(echo "$cert" | grep -o '"ServerCertificateId":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  expiration=$(echo "$cert" | grep -o '"Expiration":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  arn=$(echo "$cert" | grep -o '"Arn":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  uid=$(echo "$arn" | cut -d':' -f5)

  # Determine compliance
  if [[ "$expiration" < "$now" ]]; then
    status="Non-Compliant"
  else
    status="Compliant"
  fi

  # Print row
  printf "%-30s %-20s %-15s %-25s %-15s\n" "$name" "$id" "$uid" "$expiration" "$status"
done
