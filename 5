#!/bin/bash

echo -e "\n🔍 IAM Server Certificate Expiration Audit (Global Scope)\n"

# Get current UTC time in ISO format
now=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# List IAM server certificates
certs=$(aws iam list-server-certificates --query 'ServerCertificateMetadataList' --output json 2>/dev/null)

# Check if any certs exist
count=$(echo "$certs" | grep -c 'ServerCertificateName')

if [[ "$count" -eq 0 ]]; then
  echo "✅ No IAM server certificates found. Environment is compliant."
  exit 0
fi

# Print table header
printf "%-30s %-20s %-15s %-25s %-15s\n" "Certificate Name" "Certificate ID" "Account ID" "Expiration Date" "Status"
echo "---------------------------------------------------------------------------------------------------------------------------"

# Parse and check each certificate
echo "$certs" | grep -o '{[^}]*}' | while read -r cert; do
  name=$(echo "$cert" | grep -o '"ServerCertificateName":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  id=$(echo "$cert" | grep -o '"ServerCertificateId":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  expiration=$(echo "$cert" | grep -o '"Expiration":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  arn=$(echo "$cert" | grep -o '"Arn":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  uid=$(echo "$arn" | cut -d':' -f5)

  # Determine compliance
  if [[ "$expiration" < "$now" ]]; then
    status="Non-Compliant"
  else
    status="Compliant"
  fi

  # Print result
  printf "%-30s %-20s %-15s %-25s %-15s\n" "$name" "$id" "$uid" "$expiration" "$status"
done
