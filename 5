#!/bin/bash

echo -e "\nüîç IAM Server Certificate Expiration Audit & Auto-Removal (Global Scope)\n"

now=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
removed_count=0
total_checked=0

# List server certificates
certs=$(aws iam list-server-certificates --query 'ServerCertificateMetadataList' --output json 2>/dev/null)

# Check if any exist
if [[ "$certs" == *"[]"* || -z "$certs" ]]; then
  echo "‚úÖ No IAM server certificates found. Environment is compliant."
  exit 0
fi

# Print table header
printf "%-30s %-20s %-15s %-25s %-15s\n" "Certificate Name" "Certificate ID" "Account ID" "Expiration Date" "Status"
echo "---------------------------------------------------------------------------------------------------------------------------"

# Loop through each certificate
echo "$certs" | grep -o '{[^}]*}' | while read -r cert; do
  name=$(echo "$cert" | grep -o '"ServerCertificateName":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  id=$(echo "$cert" | grep -o '"ServerCertificateId":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  expiration=$(echo "$cert" | grep -o '"Expiration":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  arn=$(echo "$cert" | grep -o '"Arn":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  uid=$(echo "$arn" | cut -d':' -f5)
  ((total_checked++))

  if [[ "$expiration" < "$now" ]]; then
    # Expired ‚Äî delete it
    aws iam delete-server-certificate --server-certificate-name "$name" >/dev/null 2>&1
    status="REMOVED"
    ((removed_count++))
  else
    status="Compliant"
  fi

  # Print result
  printf "%-30s %-20s %-15s %-25s %-15s\n" "$name" "$id" "$uid" "$expiration" "$status"
done

echo -e "\nüìä Audit Summary:"
echo "  ‚û§ Total certificates checked: $total_checked"
echo "  üóëÔ∏è  Expired & removed: $removed_count"
