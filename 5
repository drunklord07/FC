#!/bin/bash

echo "Auditing IAM SSL/TLS server certificates for expiration"

# Initialize counters
TOTAL=0
EXPIRED=0
VALID=0
EXPIRED_CERT_ARNS=()

# Get current date in ISO 8601 format (UTC)
NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# Get all IAM server certificates
CERTS_JSON=$(aws iam list-server-certificates --output json)

# Loop over each certificate using a Python parser to handle JSON and date comparisons
EXPIRED_CERT_NAMES=$(python3 -c "
import json
from datetime import datetime, timezone
import sys

certs = json.loads('''$CERTS_JSON''')
now = datetime.strptime('$NOW', '%Y-%m-%dT%H:%M:%SZ')

expired_names = []

for cert in certs.get('ServerCertificateMetadataList', []):
    exp = cert.get('Expiration')
    name = cert.get('ServerCertificateName')
    arn = cert.get('Arn')
    if exp:
        try:
            exp_date = datetime.strptime(exp, '%Y-%m-%dT%H:%M:%SZ')
            if exp_date < now:
                print(json.dumps({'Name': name, 'Arn': arn}))
        except Exception as e:
            continue
")

# Count total certificates
TOTAL=$(echo "$CERTS_JSON" | grep -c '"ServerCertificateName"')

# Process expired certs (if any)
if [ -n "$EXPIRED_CERT_NAMES" ]; then
  echo "$EXPIRED_CERT_NAMES" | while read -r line; do
    NAME=$(echo "$line" | python3 -c "import sys, json; print(json.load(sys.stdin)['Name'])")
    ARN=$(echo "$line" | python3 -c "import sys, json; print(json.load(sys.stdin)['Arn'])")
    echo -e "\nCertificate: $NAME"
    echo "  ⚠️  EXPIRED: $ARN"
    EXPIRED_CERT_ARNS+=("$ARN")
    ((EXPIRED++))
  done
fi

# Calculate valid certificates
VALID=$((TOTAL - EXPIRED))

# Final summary
echo -e "\n===== AUDIT SUMMARY ====="
echo "Total Certificates:     $TOTAL"
echo "Valid Certificates:     $VALID"
echo "Expired Certificates:   $EXPIRED"

if [ "$EXPIRED" -gt 0 ]; then
  echo -e "\nExpired Certificate ARNs:"
  for ARN in "${EXPIRED_CERT_ARNS[@]}"; do
    echo "  - $ARN"
  done
else
  echo -e "\n✅ All IAM certificates are valid."
fi
