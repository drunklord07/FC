#!/bin/bash

echo -e "\nüîç Checking IAM Server Certificates for Expiration...\n"
printf "%-30s %-20s %-15s %-25s %-15s\n" "Certificate Name" "Certificate ID" "Account ID" "Expiration Date" "Status"

# Get current date in ISO format
now=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# List server certificates
certs=$(aws iam list-server-certificates --query 'ServerCertificateMetadataList' --output json)

# Loop through each certificate
echo "$certs" | grep -o '{[^}]*}' | while read -r cert; do
  name=$(echo "$cert" | grep -o '"ServerCertificateName":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  id=$(echo "$cert" | grep -o '"ServerCertificateId":"[^"]*"' | cut -d':' -f2 | tr -d '"')
  expiration=$(echo "$cert" | grep -o '"Expiration":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  arn=$(echo "$cert" | grep -o '"Arn":"[^"]*"' | cut -d':' -f2- | tr -d '"')
  uid=$(echo "$arn" | cut -d':' -f5)

  # Compare expiration date with current date
  if [[ "$expiration" < "$now" ]]; then
    status="Non-Compliant"
  else
    status="Compliant"
  fi

  # Print table row
  printf "%-30s %-20s %-15s %-25s %-15s\n" "$name" "$id" "$uid" "$expiration" "$status"
done
