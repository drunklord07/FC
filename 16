#!/bin/bash

REGION="ap-south-1"
echo "ðŸ” Scanning Route 53 A records for dangling IPs in region: $REGION"

# Get all hosted zones
ZONE_IDS=$(aws route53 list-hosted-zones \
  --query "HostedZones[*].Id" \
  --output text | sed 's|/hostedzone/||g')

DANGLING_RECORDS=()
TOTAL_RECORDS=0

for ZONE_ID in $ZONE_IDS; do
  echo -e "\nðŸ“˜ Hosted Zone: $ZONE_ID"

  # Get all A records in the zone
  RECORDS=$(aws route53 list-resource-record-sets \
    --hosted-zone-id "$ZONE_ID" \
    --query "ResourceRecordSets[?Type=='A'].[Name, ResourceRecords[*].Value[]]" \
    --output text)

  while IFS= read -r line; do
    NAME=$(echo "$line" | awk '{print $1}')
    IP=$(echo "$line" | awk '{print $2}')
    
    if [[ "$IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      ((TOTAL_RECORDS++))
      echo "ðŸ”Ž $NAME -> $IP"

      # Check if IP is an EIP in the account
      EIP_EXISTS=$(aws ec2 describe-addresses \
        --region "$REGION" \
        --query "Addresses[?PublicIp=='$IP']" \
        --output text)

      if [ -z "$EIP_EXISTS" ]; then
        echo "  âš ï¸  Dangling A record: $NAME -> $IP"
        DANGLING_RECORDS+=("$NAME -> $IP")
      else
        echo "  âœ… IP is allocated and in use"
      fi
    fi
  done <<< "$RECORDS"
done

# Summary
echo -e "\n===== AUDIT SUMMARY ====="
echo "Total A records checked:        $TOTAL_RECORDS"
echo "Dangling A records detected:    ${#DANGLING_RECORDS[@]}"

if [ "${#DANGLING_RECORDS[@]}" -gt 0 ]; then
  echo -e "\nâŒ Dangling A Records:"
  for record in "${DANGLING_RECORDS[@]}"; do
    echo "  - $record"
  done
else
  echo "âœ… No dangling A records found."
fi
