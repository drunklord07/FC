#!/bin/bash

non_compliant_count=0

# Get all AWS regions
regions=$(aws ec2 describe-regions --query 'Regions[*].RegionName' --output text)

for region in $regions; do
  # Get all SQS queues in this region
  queue_urls=$(aws sqs list-queues --region "$region" --query 'QueueUrls' --output text 2>/dev/null)

  if [[ -z "$queue_urls" ]]; then
    continue
  fi

  for queue_url in $queue_urls; do
    # Get policy
    raw_policy=$(aws sqs get-queue-attributes \
      --region "$region" \
      --queue-url "$queue_url" \
      --attribute-names Policy \
      --query 'Attributes.Policy' \
      --output text 2>/dev/null)

    if [[ "$raw_policy" != "None" && "$raw_policy" != "null" ]]; then
      policy=$(echo "$raw_policy" | tr -d '[:space:]')

      if [[ "$policy" == *'"Effect":"Allow"'* && "$policy" == *'"Principal":"*"'* ]]; then
        ((non_compliant_count++))
      elif [[ "$policy" == *'"Effect":"Allow"'* && "$policy" == *'"AWS":"*"'* ]]; then
        ((non_compliant_count++))
      fi
    fi
  done
done

echo "Total Non-Compliant SQS Queues: $non_compliant_count"
