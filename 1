#!/bin/bash

REGION="us-east-1"  # Change as needed

echo -e "\nAuditing SQS queues in region: $REGION\n"
echo -e "Queue URL\t\t\t\t\tAccount ID\t\tStatus"

# Get list of SQS queues
queue_urls=$(aws sqs list-queues --region "$REGION" --query 'QueueUrls' --output text)

if [[ -z "$queue_urls" ]]; then
  echo "No queues found in region $REGION."
  exit 0
fi

for queue_url in $queue_urls; do
  # Extract AWS Account ID from the queue URL
  account_id=$(echo "$queue_url" | cut -d '/' -f 4)

  # Get the policy attribute as raw text
  policy=$(aws sqs get-queue-attributes \
    --region "$REGION" \
    --queue-url "$queue_url" \
    --attribute-names Policy \
    --query 'Attributes.Policy' \
    --output text 2>/dev/null)

  # Default status
  status="Compliant"

  # Check for public access
  if [[ "$policy" != "None" && "$policy" != "null" ]]; then
    if [[ "$policy" == *'"Effect":"Allow"'* && "$policy" == *'"Principal":"*"'* ]]; then
      status="Non-Compliant"
    elif [[ "$policy" == *'"Effect":"Allow"'* && "$policy" == *'"AWS":"*"'* ]]; then
      status="Non-Compliant"
    fi
  fi

  # Print result
  printf "%s\t%s\t%s\n" "$queue_url" "$account_id" "$status"
done
